<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filament Lager | Live-Ãœbersicht & Barcode-Scanner</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    
    <style>
        /* ========================================================= */
        /* --- 1. GLOBALE VARIABLEN & GRUNDEINSTELLUNGEN --- */
        /* ========================================================= */
        :root {
            --primary-color: #4A90E2;      
            --accent-color: #28a745;       
            --background-color: #f4f7f9;
            --card-background: #ffffff;
            --text-color: #333333;
            --secondary-color: #2196F3;
            --border-color: #e0e0e0;
            --success-color: #4CAF50;      /* Status: Aktiv/Neu */
            --warning-color: #FFC107;      /* Status: Gebraucht */
            --danger-color: #F44336;       /* Status: Archiviert/Aufgebraucht */
        }
        
        body {
            font-family: 'Poppins', 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 20px 10px;
            background-color: var(--background-color);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0;
        }
        
        .card-section {
            background-color: var(--card-background);
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); 
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            font-size: 2em;
            font-weight: 700;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 30px;
        }

        h2 {
            font-weight: 600;
            color: var(--text-color);
            font-size: 1.5rem;
            margin-top: 0;
            margin-bottom: 20px;
        }
        
        /* ========================================================= */
        /* --- 2. DASHBOARD & SUCHE STILE --- */
        /* ========================================================= */

        #filter-input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        #filter-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
            outline: none;
        }
        
        .filament-post {
            background: var(--card-background); padding: 20px; margin-bottom: 15px; border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); position: relative; border-left: 5px solid transparent;
            transition: all 0.3s ease;
        }

        .highlight {
            border-left-color: var(--secondary-color); box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
            animation: pulse-border 2s infinite alternate;
        }
        
        .filament-title-row {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        }

        .filament-material { color: var(--text-color); font-size: 1.2em; font-weight: 700; }
        .filament-id-tag {
            font-size: 0.8em; font-weight: 600; color: var(--secondary-color); padding: 4px 10px;
            background: rgba(33, 150, 243, 0.1); border-radius: 50px;
        }

        .details-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px 15px; font-size: 0.9em;
            padding: 10px 0; border-top: 1px dashed var(--border-color); margin-bottom: 10px;
        }

        .detail-label { color: #757575; font-weight: 500; }
        .detail-value { font-weight: 400; color: var(--text-color); }
        
        .status-badge {
            position: absolute; top: 0; right: 0; padding: 6px 14px; border-top-right-radius: 10px;
            border-bottom-left-radius: 10px; font-size: 0.8em; font-weight: bold; color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .status-badge.aktiv { background: var(--success-color); }
        .status-badge.gebraucht { background: var(--warning-color); color: var(--text-color); }
        .status-badge.archiviert { background: var(--danger-color); }

        .timestamp {
            font-size: 0.75em; color: #9E9E9E; text-align: right; border-top: 1px dashed var(--border-color);
            padding-top: 10px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
        }

        .action-buttons button {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.9em;
        }
        
        .btn-gebraucht {
            background-color: var(--warning-color);
            color: var(--text-color);
        }
        .btn-gebraucht:hover {
            background-color: #ffda79;
        }

        .btn-aufgebraucht {
            background-color: var(--danger-color);
            color: white;
        }
        .btn-aufgebraucht:hover {
            background-color: #c43c30;
        }
        
        /* Spinner und Scanner Styles bleiben unverÃ¤ndert */
        @keyframes pulse-border {
            from { box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
            to { box-shadow: 0 6px 15px rgba(33, 150, 243, 0.4); }
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #spinner { display: none; position: fixed; top: 20px; right: 20px; z-index: 1000; }
        #spinner > div { border: 4px solid #f0f0f0; border-top: 4px solid var(--accent-color); border-radius: 50%; width: 25px; height: 25px; animation: spin 1s linear infinite; }
        #toggleSection { display: none; }
        .toggle-button-container { text-align: center; margin-bottom: 20px; }
        #toggle-scanner-button { padding: 12px 30px; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: 600; transition: background-color 0.2s, transform 0.1s; }
        #toggle-scanner-button:hover { background-color: #218838; transform: translateY(-2px); }
        #interactive.viewport { width: 100%; max-width: 400px; height: 250px; margin: 15px auto; position: relative; overflow: hidden; border: 3px solid var(--primary-color); border-radius: 8px; box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1); }
        #interactive.viewport canvas, video { width: 100%; height: 100%; object-fit: cover; display: block; }
        #barcode-output { margin: 20px 0 15px; padding: 15px; border: 2px solid var(--accent-color); background-color: #e2ffe8; font-weight: 700; font-size: 1.2rem; border-radius: 8px; word-break: break-all; text-align: center; }
        .controls { text-align: center; margin-bottom: 20px; }
        .controls button, #copy-button { padding: 10px 20px; background-color: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: background-color 0.2s, transform 0.1s; margin: 5px; }
        .controls button:hover { background-color: #3870b8; transform: translateY(-1px); }
        #google-form-embed { width: 100%; height: 600px; border: 1px solid var(--border-color); border-radius: 8px; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Filament Lager Verwaltung ðŸ“¦</h1>
        <p style="text-align: center; color: #757575;">Live-Ãœbersicht im Fokus, HinzufÃ¼gen auf Knopfdruck.</p>
    </header>
    
    <div class="toggle-button-container">
        <button id="toggle-scanner-button" onclick="toggleScanner()">
            + Filament hinzufÃ¼gen (Barcode-Scanner/Formular Ã¶ffnen)
        </button>
    </div>

    <div id="toggleSection" class="card-section">
        <h2>ðŸ“· Barcode-Erfassung</h2>
        <div id="interactive" class="viewport"></div>
        <div class="controls">
            <button onclick="startScanner()">Scanner neu starten</button>
            <button onclick="stopScanner()">Scanner stoppen</button>
        </div>
        <h3>Erkanntes ID-Ergebnis:</h3>
        <div id="barcode-output">Hier erscheint der gescannte Code...</div>
        <button id="copy-button" onclick="copyBarcode()">ðŸ“‹ Manuell kopieren</button>
        <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 30px 0;">
        <h2>ðŸ“„ Filament eintragen</h2>
        <iframe id="google-form-embed" src="https://docs.google.com/forms/d/e/1FAIpQLSdHpbzo_r3437upRg6P-diaE74N16IBiM422_TLBasa_LoOfw/viewform?embedded=true"></iframe>
    </div>
    
    <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 30px 0;">

    <div id="dashboard-section" class="card-section">
        <h2 style="margin-bottom: 10px;">Live BestandsÃ¼bersicht: <span id="roll-count">0</span> Rollen</h2>
        
        <input type="text" id="filter-input" placeholder="Filament suchen (Material, Farbe, ID, Hersteller...)" onkeyup="filterPosts()">

        <div id="spinner">
            <div></div>
        </div>
        <div id="postsContainer">
            <div style="text-align: center; padding: 40px; color: #757575;">Daten werden geladen...</div>
        </div>
    </div>
</div>

<script>
    let globalFilamentData = []; 
    
    // =========================================================
    // --- JAVASCRIPT: DASHBOARD & ACTION LOGIK (CODE 1) ---
    // =========================================================
    const postsContainer = document.getElementById('postsContainer');
    const spinner = document.getElementById('spinner');
    const rollCount = document.getElementById('roll-count');
    const toggleSection = document.getElementById('toggleSection');
    const toggleButton = document.getElementById('toggle-scanner-button');
    const filterInput = document.getElementById('filter-input');
    
    // WICHTIG: ERSETZEN SIE DIESE URL durch Ihre Web-App-URL nach der NEUEN Bereitstellung!
    const API_URL = 'https://script.google.com/macros/s/AKfycbzu8NcY-qVMmNu7197S96GUGyE2Vn-AvwAhzdxorabk3gaSOiAxCHRIgiDzurbY7lVF/exec'; 

    /**
     * Erstellt das HTML fÃ¼r eine Filament-Rolle inkl. Action-Buttons
     */
    function createPostHTML(filament, isNewest) {
        let statusClass = 'aktiv';
        const statusText = String(filament.status).toLowerCase().trim();
        
        if (statusText.includes('gebraucht')) {
            statusClass = 'gebraucht';
        } else if (statusText.includes('archiviert') || statusText.includes('aufgebraucht')) {
            statusClass = 'archiviert';
        } else if (statusText.includes('aktiv')) {
            statusClass = 'aktiv';
        }
        
        const div = document.createElement('div');
        div.className = 'filament-post';
        if (isNewest) div.classList.add('highlight'); 

        div.innerHTML = `
            <div class="status-badge ${statusClass}">
                ${String(filament.status).toUpperCase()}
            </div>
            <div class="filament-title-row">
                <span class="filament-material">${filament.material}</span>
                <span class="filament-id-tag">ID: ${filament.id}</span>
            </div>
            <div class="details-grid">
                <div class="detail-label">Farbe</div><div class="detail-value">${filament.color}</div>
                <div class="detail-label">Hersteller</div><div class="detail-value">${filament.brand}</div>
                <div class="detail-label">Gewicht</div><div class="detail-value">${filament.weight} g (Start: ${filament.initialWeight} g)</div>
                <div></div>
            </div>
            <div class="timestamp">
                Eingetragen am: ${new Date(filament.timestamp).toLocaleDateString()}
            </div>
            
            <div class="action-buttons">
                <button class="btn-gebraucht" onclick="updateFilamentStatus('${filament.id}', 'Gebraucht', this)">
                    Als Gebraucht markieren
                </button>
                <button class="btn-aufgebraucht" onclick="updateFilamentStatus('${filament.id}', 'Aufgebraucht', this)">
                    Als Aufgebraucht markieren
                </button>
            </div>
        `;
        return div;
    }

    /**
     * NEUE FUNKTION: Sendet eine POST-Anfrage zur StatusÃ¤nderung an Google Apps Script.
     * @param {string} id - Die ID (Spalte F) des Filaments.
     * @param {string} newStatus - Der neue Status ("Gebraucht" oder "Aufgebraucht").
     * @param {HTMLElement} button - Der geklickte Button fÃ¼r Feedback.
     */
    async function updateFilamentStatus(id, newStatus, button) {
        if (!confirm(`Status von ID ${id} auf "${newStatus}" Ã¤ndern?`)) {
            return;
        }

        const originalText = button.textContent;
        button.textContent = 'Wird gesendet...';
        button.disabled = true;

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    // Die ID, der Status und die Aktion fÃ¼r doPost
                    action: 'updateStatus',
                    id: id,
                    newStatus: newStatus
                })
            });

            const result = await response.json();

            if (result.success === true) {
                button.textContent = 'Erfolg! âœ…';
                // Die Seite nach erfolgreichem Update neu laden
                loadPosts(true); 

            } else {
                button.textContent = 'Fehler! âŒ';
                alert('Fehler beim Ã„ndern des Status: ' + result.message);
                
            }
        } catch (error) {
            console.error('Fetch Fehler:', error);
            alert('Netzwerkfehler beim Aktualisieren des Status.');
        } finally {
            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
            }, 1000); 
        }
    }


    /**
     * Zeigt die Liste der Filamente im Container an
     */
    function renderPosts(posts, filterTerm) {
        postsContainer.innerHTML = '';
        
        if (posts.length === 0) {
            postsContainer.innerHTML = `<div style="text-align: center; padding: 40px; color: #757575;">
                ${filterTerm ? 'Keine Filamente gefunden, die der Suche entsprechen.' : 'Keine Filamente im Lager gefunden.'}
            </div>`;
            rollCount.textContent = 0;
            return;
        }
        
        // Die Rollenzahl wird hier nicht nur auf die gefilterte Liste gesetzt, 
        // sondern auf die Gesamtzahl, wenn kein Filter aktiv ist.
        const totalCount = filterTerm ? globalFilamentData.length : posts.length;
        rollCount.textContent = totalCount;

        posts.forEach((filament, i) => {
            // Nur der neueste Eintrag erhÃ¤lt das Highlight, wenn nicht gefiltert wird
            postsContainer.appendChild(createPostHTML(filament, i === 0 && filterTerm === ''));
        });
    }

    /**
     * Filtert die globale Filament-Liste basierend auf dem Suchfeld
     */
    function filterPosts() {
        if (globalFilamentData.length === 0) return;
        
        const searchTerm = filterInput.value.toLowerCase().trim();
        
        if (searchTerm === '') {
            renderPosts(globalFilamentData, '');
            return;
        }

        const filteredPosts = globalFilamentData.filter(filament => {
            const searchString = `${filament.material} ${filament.color} ${filament.brand} ${filament.id} ${filament.status}`.toLowerCase();
            return searchString.includes(searchTerm);
        });

        renderPosts(filteredPosts, searchTerm);
    }


    /**
     * LÃ¤dt die Daten von der API und aktualisiert die Anzeige
     */
    async function loadPosts(showSpinner = false) {
        if (filterInput.value.trim() !== '' && !showSpinner) {
             return; 
        }

        if (showSpinner) spinner.style.display = 'block'; 

        try {
            // HinzufÃ¼gen des Action-Parameters fÃ¼r die getFilaments Funktion in Code.gs
            const res = await fetch(API_URL + '?action=getFilaments');
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            const posts = await res.json();
            
            // Sortiere hier einmalig, um das Highlight korrekt zu setzen
            posts.sort((a, b) => b.id - a.id);
            globalFilamentData = posts; 

            if (filterInput.value.trim() === '') {
                 renderPosts(globalFilamentData, '');
            } else {
                 filterPosts();
            }
            
        } catch (error) {
            console.error("Fehler beim Laden der Filamente:", error);
            postsContainer.innerHTML = '<div style="color: var(--danger-color); text-align: center; padding: 40px;">Ein schwerer Fehler ist aufgetreten. Bitte API-URL und Berechtigungen prÃ¼fen.</div>';
            rollCount.textContent = 'Fehler';
        } finally {
            spinner.style.display = 'none';
        }
    }

    // Automatische Aktualisierung der Ãœbersicht alle 30 Sekunden (OPTIMIERT)
    const UPDATE_INTERVAL_MS = 30000;
    setInterval(() => loadPosts(true), UPDATE_INTERVAL_MS); 


    // =========================================================
    // --- JAVASCRIPT: SCANNER LOGIK (CODE 2) ---
    // =========================================================

    let isScannerRunning = false;
    let lastScannedCode = null;
    let scanDebounceTimer = null;
    
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();

    function playBeep() {
        if (audioContext.state === 'suspended') { audioContext.resume(); }
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.type = 'square';
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.5, audioContext.currentTime); 
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.1); 
    }
    
    function autoCopy(code) {
        navigator.clipboard.writeText(code).then(() => {
            const outputElement = document.getElementById('barcode-output');
            outputElement.style.backgroundColor = '#d4edda';
            setTimeout(() => {
                outputElement.style.backgroundColor = '#e2ffe8';
            }, 500);
        }).catch(err => {
            console.warn('Automatisches Kopieren fehlgeschlagen.', err);
        });
    }

    function startScanner() {
        if (isScannerRunning) return;

        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'), 
                constraints: {
                    facingMode: "environment" 
                }
            },
            decoder: {
                readers: ["ean_reader", "code_128_reader", "code_39_reader"] 
            }
        }, function(err) {
            if (err) {
                document.getElementById('barcode-output').innerText = 'Fehler beim Starten der Kamera. Bitte HTTPS verwenden und Berechtigungen erteilen.';
                console.error(err);
                return
            }
            Quagga.start();
            isScannerRunning = true;
        });

        Quagga.onDetected(function(result) {
            const code = result.codeResult.code;

            if (code !== lastScannedCode || !scanDebounceTimer) {
                
                document.getElementById('barcode-output').innerText = code;
                
                playBeep();
                autoCopy(code); 
                
                lastScannedCode = code;
                if (scanDebounceTimer) clearTimeout(scanDebounceTimer);
                scanDebounceTimer = setTimeout(() => {
                    scanDebounceTimer = null;
                    lastScannedCode = null; 
                }, 2000); 
            }
        });
    }

    function stopScanner() {
        if (!isScannerRunning) return;
        Quagga.stop();
        isScannerRunning = false;
        if (scanDebounceTimer) clearTimeout(scanDebounceTimer);
    }

    function copyBarcode() {
        const barcodeText = document.getElementById('barcode-output').innerText.trim();
        if (barcodeText.includes('Hier erscheint der gescannte Code') || barcodeText.startsWith('Fehler beim Starten')) {
            alert('Bitte zuerst einen Barcode scannen!');
            return;
        }

        navigator.clipboard.writeText(barcodeText).then(() => {
            alert('Barcode "' + barcodeText + '" manuell erfolgreich kopiert!');
        }).catch(err => {
            console.error('Kopieren fehlgeschlagen: ', err);
            alert('Kopieren fehlgeschlagen.');
        });
    }


    // =========================================================
    // --- JAVASCRIPT: TOGGLE FUNKTION ---
    // =========================================================

    function toggleScanner() {
        const isVisible = toggleSection.style.display === 'block';

        if (isVisible) {
            toggleSection.style.display = 'none';
            toggleButton.innerText = '+ Filament hinzufÃ¼gen (Barcode-Scanner/Formular Ã¶ffnen)';
            stopScanner();
        } else {
            toggleSection.style.display = 'block';
            toggleButton.innerText = 'âœ• Scanner/Formular schlieÃŸen';
            startScanner();
        }
    }


    // ERSTES LADEN
    window.onload = function() {
        loadPosts(false);
    }
</script>

</body>
</html>
